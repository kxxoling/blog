---
title: Time Machine å°æŠ€å·§
description: ä¸€äº› Time Machine ä½¿ç”¨å°æŠ€å·§
tags: [macOS, TimeMachine, Ubuntu]
createdAt: 2022-08-16
---

Time Machine æ˜¯ macOS çš„å¤‡ä»½å·¥å…·ï¼Œå®ƒå¯ä»¥å°†æ‚¨çš„æ–‡ä»¶å¤‡ä»½åˆ°ç¡¬ç›˜å’Œç½‘ç›˜ä¸Šï¼Œç”¨ä½œç³»ç»Ÿçš„å¤‡ä»½æˆ–è€…æ–‡ä»¶çš„è¿˜åŸã€‚æ‰“å¼€ç³»ç»Ÿ Time Machine è®¾ç½®å°±å¯ä»¥å¼€å¯å®ƒï¼Œé¦–æ¬¡å¤‡ä»½ä¼šèŠ±ä¸Šæ¯”è¾ƒå¤šçš„ï¼Œå¹¶ä¸”ä¼šæœ‰ CPU é«˜åº¦å ç”¨ã€‚Time Machine çš„ç›®æ ‡å¯ä»¥æ˜¯ç¡¬ç›˜ï¼Œç½‘ç›˜ï¼Œæˆ–è€… iCloudï¼Œå¦‚æœä½ å®¶é‡Œæœ‰ NAS æœåŠ¡å™¨å¯ä»¥å¼€å¯è‡ªå¸¦çš„ Time Machine æœåŠ¡ï¼ˆç¾¤æ™–ã€å¨è”é€šç­‰ä¸»æµ NAS ç³»ç»Ÿéƒ½è‡ªå¸¦äº†ï¼‰ï¼Œæˆ–è€…åƒæˆ‘ä¸€æ ·åœ¨ Ubuntu 22.04 ä¸Šè®¾ç½® Time Machine æœåŠ¡ã€‚

## åœ¨ Ubuntu ä¸Šè®¾ç½®

åœ¨ Ubuntu ä¸Šè®¾ç½® Time Machine ä¾èµ– 2 ä¸ªæœåŠ¡ï¼Œ[netatalk](https://en.wikipedia.org/wiki/Netatalk) å’Œ [avahi](<https://en.wikipedia.org/wiki/Avahi_(software)>)ï¼Œåˆ†åˆ«æä¾›äº† [Apple Filing Protocol (AFP)](https://en.wikipedia.org/wiki/Apple_Filing_Protocol) å’Œå…¼å®¹ [Bonjour](<https://en.wikipedia.org/wiki/Bonjour_(software)>) çš„ mDNS æœåŠ¡ï¼Œæœ‰äº†å®ƒä»¬ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ Ubuntu ä½œä¸º Time Machine çš„æœåŠ¡å™¨ã€‚

```shell
# å®‰è£… netatalk å’Œ avahi
sudo apt install netatalk avahi-daemon
```

å®‰è£…åéœ€è¦é…ç½®ä¸‹ Time Machine å¤‡ä»½çš„ä½ç½®ï¼Œé€‰å—ç¡¬ç›˜æˆ–è€… SMB ç›®å½•ï¼Œè®¾ç½®å¥½æƒé™å¹¶å°† netatalk é…ç½®å¥½ï¼š

```shell
# é…ç½® Time Machine å¤‡ä»½çš„ä½ç½®
mkdir timemachine
sudo chown nobody:nogroup timemachine
sudo chmod 777 timemachine
```

```ini
; æ·»åŠ åˆ° /etc/netatalk/afp.conf
; æˆ–è€…å–æ¶ˆåŸæ–‡ä»¶æ³¨é‡Šè¿›è¡Œä¿®æ”¹
; å…¶å®ƒéƒ¨åˆ†ä¿æŒä¸åŠ¨å°±å¯ä»¥äº†
[Time Machine] ; è¿™é‡Œæ˜¯ Time Machine æœåŠ¡çš„åç§°ï¼Œä¹Ÿå¯ä»¥è®¾ç½®æˆä½ å–œæ¬¢çš„åå­—
path = /path/to/timemachine ; é…ç½®å¥½åˆšåˆšè®¾ç½®çš„ç›®å½•
time machine = yes
```

ä¹‹åå†é‡å¯ netatalk æœåŠ¡ï¼š

```shell
sudo service netatalk restart
```

è¿™æ—¶å€™ macOS ä¸Šçš„ Time Machine å°±å¯ä»¥æœç´¢åˆ°ä½ åˆšåˆšè®¾ç½®å¥½çš„æœåŠ¡äº†ã€‚

## ä½¿ç”¨ docker è®¾ç½® Time Machine æœåŠ¡

åœ¨ç½‘ä¸Šçœ‹åˆ°ä¹Ÿå¯ä»¥ä½¿ç”¨ docker æä¾› Time Machine æœåŠ¡ï¼Œæ€è·¯å¤§åŒå°å¼‚ï¼Œç”¨ Samba ä»£æ›¿äº† netatalkï¼Œ

### åˆ›å»ºå¤‡ä»½ç›®å½•

åœ¨åˆé€‚çš„ç£ç›˜ä¸Šåˆ›å»ºå¤‡ä»½çš„ç›®æ ‡ç›®å½•

```shell
mkdir ~/tmbackup
mkdir ~/tmbackup/config
mkdir ~/tmbackup/data
```

### docker-compose é…ç½®

```yaml
version: '3.4'

services:
  avahi:
    container_name: avahi
    image: solidnerd/avahi:0.7
    network_mode: host
    volumes:
      - ./avahi:/etc/avahi:ro
    restart: unless-stopped

  samba:
    container_name: samba
    image: dperson/samba
    environment:
      TZ: 'Asia/Shanghai'
    networks:
      - default
    ports:
      - '137:137/udp'
      - '138:138/udp'
      - '139:139/tcp'
      - '445:445/tcp'
    read_only: true
    tmpfs:
      - /tmp
    restart: unless-stopped
    stdin_open: true
    tty: true
    volumes:
      - /home/alex/tmbackup/data:/backup:z # è¿™é‡Œé…ç½®å¥½ä½ è‡ªå·±çš„ tmbackup volume
    command: '-s "Time Machine Backup;/backup;yes;no" -u "alex;alexspasswd"' # è®°å¾—ä¿®æ”¹ç”¨æˆ·åå’Œå¯†ç 
```

### åˆå§‹åŒ– Avahi é…ç½®å¹¶ç¦ç”¨ DBUS

```shell
# åˆå§‹åŒ– Avahi é…ç½®
sudo docker create --name avahi-config solidnerd/avahi:0.7
sudo docker cp avahi-config:/etc/avahi .
sudo docker rm avahi-config

# ç¦ç”¨ DBUS
sed -i 's/#enable-dbus=yes/enable-dbus=no/' avahi/avahi-daemon.conf
```

### åˆ›å»º Avahi é…ç½®æ¥å¹¿æ’­ Samba æœåŠ¡

```shell
cat <<EOT >> avahi/services/smb.conf
<?xml version="1.0" standalone='no'?>
<!DOCTYPE service-group SYSTEM "avahi-service.dtd">
<service-group>
<name replace-wildcards="yes">%h</name>
<service>
  <type>_adisk._tcp</type>
  <txt-record>sys=waMa=0,adVF=0x100</txt-record>
  <txt-record>dk0=adVN=Time Capsule,adVF=0x82</txt-record>
</service>
<service>
  <type>_smb._tcp</type>
  <port>445</port>
</service>
<service>
  <type>_device-info._tcp</type>
  <port>0</port>
  <txt-record>model=RackMac</txt-record>
</service>
</service-group>
EOT
```

### å¯åŠ¨ docker æœåŠ¡

```shell
docker-compose up -d
```

## åŠ é€Ÿ Time Machine å¤‡ä»½

### è§£é™¤ TM å¤‡ä»½é€Ÿåº¦é™åˆ¶

åœ¨ç½‘ä¸Šæœåˆ°ä¸€æ¡åŠ é€Ÿå¤‡ä»½çš„å‘½ä»¤ï¼š`sudo sysctl debug.lowpri_throttle_enabled=0`ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ `sudo sysctl debug.lowpri_throttle_enabled=1` è¿˜åŸè®¾ç½®ï¼Œä½†æ˜¯åœ¨ macOS 12.5 ä¸ŠæˆåŠŸå°†å¤‡ä»½é€Ÿåº¦ä» 2MB/s åŠ é€Ÿåˆ° 1MB/sã€‚ğŸ’© ä»…ä¾›å‚è€ƒã€‚

### ç­›é€‰ TM å¤‡ä»½çš„ç›®å½•

å¦ä¸€ä¸ªå¯ä»¥æå‡å¤‡ä»½é€Ÿåº¦çš„åŠæ³•æ˜¯å‡å°‘è¦å¤‡ä»½çš„æ–‡ä»¶ï¼Œæ¯”å¦‚äº‘ç›˜ç›®å½•ã€å¯ä»¥è½»æ¾ä»ç½‘ä¸Šä¸‹è½½çš„æ–‡ä»¶ã€ç¼“å­˜ç›®å½•ç­‰ç­‰ã€‚æ¯”å¦‚

- docker å®¹å™¨ `~/Library/Containers/com.docker.docker`
- Python è™šæ‹Ÿç¯å¢ƒ `~/.virtualenvs`
- `~/.gem`
- `~/.npm`
- pip ç¼“å­˜ç›®å½•
- å„çº§ `node_modules`
- `~/.pnpm-store`
- `~/.cache`
- `~/Applications`
- `~/Applications (Parallels)`
- `~/Library/Caches`
- `~/.VirtualBox VMs`
- `~/Parallels`
- `~/vagrant.d`
- `~/Dropbox`
- `~/Google Drive`
- `/Applications`
- `/Library/Application Support/Steam/steamapp/common`

### ä½¿ç”¨å‘½ä»¤è¡Œè®¾ç½® TM å¤‡ä»½çš„ç›®å½•

macOS æä¾›äº†ä¸€ä¸ª tmutil å‘½ä»¤ï¼Œå¯ä»¥è®¾ç½®å¤‡ä»½çš„ç›®å½•ï¼Œæ¯”å¦‚

```shell
tmutil addexclusion "$(pwd)" # å°†å½“å‰ç›®å½•æ·»åŠ åˆ°å¤‡ä»½ç›®å½•ä¸­
tmutil isexcluded "$(pwd)" # æŸ¥çœ‹æ˜¯å¦è¢«æ’é™¤
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`tmutils addexclusion some_dir` æ’é™¤çš„ç›®å½•ä¸ä¼šåœ¨ GUI åº”ç”¨ä¸­æ˜¾ç¤ºï¼Œåªèƒ½ä½¿ç”¨ CLI å‘½ä»¤æŸ¥çœ‹ï¼š`sudo mdfind "com_apple_backup_excludeItem = 'com.apple.backupd'"`ã€‚ä½†æ˜¯ GUI åº”ç”¨ä¸­çš„è®¾ç½®æ˜¯å¯ä»¥åœ¨ CLI ä¸­æŸ¥çœ‹çš„ï¼š

```shell
$ defaults read /Library/Preferences/com.apple.TimeMachine.plist SkipPaths

(
    "~windrunner/Drive",
    "~windrunner/.npm",
    "~windrunner/.cache",
    "~windrunner/.pnpm-store"
)
```

### æ’é™¤æ‰€æœ‰ node_modules

æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼ŒTM å¹¶ä¸æ”¯æŒç›®å½•çš„è§„åˆ™åŒ¹é…ï¼Œæ‰€ä»¥éœ€è¦æ’é™¤æ‰€æœ‰ `node_modules` ç›®å½•æœ‰ä¸€ç‚¹éº»çƒ¦ï¼š

```shell
find `pwd` -maxdepth 3 -type d -name 'node_modules' | xargs -n 1 tmutil addexclusion
```

å¯¹äºæ–°æ·»åŠ çš„é¡¹ç›®å°±éœ€è¦æ–‡ä»¶ç³»ç»Ÿ hook æˆ–è€…å®šæ—¶ä»»åŠ¡æ¥ä¿è¯äº†ã€‚

å‚è€ƒï¼š

- [Backup a Mac to a Linux server over a network using Time Machine and Docker](https://alexlubbock.com/time-machine-network-backup-linux)
- [Exclude folders by regex (?) from time machine backup](https://superuser.com/a/1267863/715265)
- [On OS X, what files are excluded by rule from a Time Machine backup?](https://apple.stackexchange.com/a/25833/101989)
